function GameBGmapControl(){}function DisplayControl(t,i,e){var n=new offScreen;this.buffer=n;var s=document.getElementById(t);s.width=i,s.height=e;var r=s.getContext("2d");this.cw=s.width,this.ch=s.height,r.font="16px 'Arial'",this.lighter_enable=!0,this.putPattern=function(t,i,e,s,r,a){n.drawImgXYWHXYWH(t,i.x,i.y,i.w,i.h,e,s,r,a)},this.setBgPattern=function(t){bg_ptn=t},this.print=function(t,i,e,s){Boolean(s)||(s="limegreen"),n.fillText(t,i,e,s)},this.putImage=function(t,i,e){n.drawImgXY(t,i,e)},this.putImage2=function(t,i,e,s,r){n.drawImgXYWH(t,i,e,s,r)},this.putImageTransform=function(t,i,e,s,r,a,h){n.putImageTransform(t,i,e,s,r,a,h)},this.transform=function(t,i,e,s){n.Transform(t,i,e,s,0,0)},this.putFunc=function(t){n.putFunc(t)},this.clear=function(t){n.allClear(0,0,s.width,s.height),Boolean(t)&&n.fillRect(0,0,s.width,s.height,t)},this.fill=function(t,i,e,s,r){n.fillRect(t,i,e,s,r)},this.reset=function(){n.reset()},this.draw=function(){n.draw(r)},this.count=function(){return n.count()}}function GameAssetManager(){var t=[];this.imageLoad=function(i,e){var n=new Image;return n.src=e,n.ready=!1,n.addEventListener("load",function(){this.ready=!0}),t[i]=n,n},this.image=t;var i=[],e=[],n=[],s=[];this.soundLoad=function(t,r){return i[t]=new Audio(r+".mp3"),i[t].ready=!1,i[t].addEventListener("loadeddata",function(t){this.ready=!0}),e[t]=r,n[t]=0,s[t]=i[t].ready,i[t]},this.sound=i,this.check=function(){var e="<br>";for(var n in t){var s=t[n].src.split("/",20);e+=n+" "+t[n].name+" "+s[s.length-1]+" "+(t[n].ready?"o":"x")+"<br>"}for(var n in i){var s=i[n].src.split("/",20);e+=n+" "+i[n].name+" "+s[s.length-1]+" "+(i[n].ready?"o":"x")+"<br>"}return e}}function GameCore(t){var i=0,e=Date.now();window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,n){++i>60&&(i=1,e=Date.now());var s,r=e+Math.round(16.666666666666668*i)-Date.now();r<=0&&(r=1),setTimeout(t,r)};var n=!1,s=new GameTaskControl(this),r=new GameAssetManager,a=new inputKeyboard,h=new inputMouse,o=[];for(var c in t){var u=t[c];o[c]=new DisplayControl(u.canvasId,u.resolution.w,u.resolution.h)}if(t.length>0)var l=o[0];var f=new GameSpriteControl(this),d=[];this.setSpFont=function(t){var i={Image:r.image[t.id],pattern:t.pattern},e=new GameSpriteFontControl(this,i);d[t.name]=e};var r=new GameAssetManager,m=new soundControl(r);function y(){n&&(s.step(),s.draw(),requestAnimationFrame(arguments.callee))}document.getElementById("console").innerHTML="START GAME CORE",this.task=s,this.asset=r,this.keyboard=a,this.mouse=h,this.dsp=l,this.screen=o,this.sound=m,this.sprite=f,this.font=d,f.useScreen(0),this.run=function(){n=!0,requestAnimationFrame(y)},this.pause=function(){n=!1}}class GameTask{id;enable;visible;preFlag;constructor(t){this.id=t,this.enable=!0,this.visible=!0,this.preFlag=!1}init(t){}pre(t){}step(t){}draw(t){}post(t){}}function GameTaskControl(t){var i=[],e=0,n="";function s(){for(var t in e=0,n="",i)n+=t+" ",e++}this.read=function(t){return i[t]},this.add=function(e){i[e.id]=e,e.init(t),s()},this.del=function(t){i[task.id].post(),delete i[task.id],s()},this.init=function(e){i[e].init(t)},this.step=function(){for(var e in i){var n=i[e];n.preFlag||(n.pre(t),n.preFlag=!0),n.enable&&n.step(t)}},this.draw=function(){for(var e in i){var n=i[e];n.visible&&n.draw(t)}},this.count=function(){return e},this.namelist=function(){return n}}function inputKeyboard(){var t=[];this.upkey=!1,this.downkey=!1,this.leftkey=!1,this.rightkey=!1,this.shift=!1,this.ctrl=!1,this.alt=!1,this.space=!1,this.qkey=!1,this.wkey=!1,this.ekey=!1,this.akey=!1,this.skey=!1,this.dkey=!1,this.zkey=!1,this.xkey=!1,this.ckey=!1,window.addEventListener("blur",function(i){t=[]},!1),window.addEventListener("keydown",function(i){t[i.keyCode]=!0},!1),window.addEventListener("keyup",function(i){t[i.keyCode]=!1},!1),this.check=function(){for(var i in function t(){this.upkey=!1,this.downkey=!1,this.leftkey=!1,this.rightkey=!1,this.shift=!1,this.ctrl=!1,this.space=!1,this.qkey=!1,this.wkey=!1,this.ekey=!1,this.akey=!1,this.skey=!1,this.dkey=!1,this.zkey=!1,this.xkey=!1,this.ckey=!1}(),t)switch(i){case"16":this.shift=t[16];break;case"17":this.ctrl=t[17];break;case"18":this.alt=t[18];break;case"32":this.space=t[32];break;case"38":this.upkey=t[38];break;case"40":this.downkey=t[40];break;case"37":this.leftkey=t[37];break;case"39":this.rightkey=t[39];break;case"65":this.akey=t[65];break;case"67":this.ckey=t[67];break;case"68":this.dkey=t[68];break;case"69":this.ekey=t[69];break;case"81":this.qkey=t[81];break;case"83":this.skey=t[83];break;case"87":this.wkey=t[87];break;case"88":this.xkey=t[88];break;case"90":this.zkey=t[90]}return t},this.state=function(){return keymapt}}function inputMouse(){var t={x:0,y:0,button:0,wheel:0},i=0,e=0,n=-1,s=0,r=document;r.addEventListener("mousemove",function(t){i=t.clientX,e=t.clientY},!1),r.addEventListener("mousedown",function(t){n=t.button},!1),r.addEventListener("mouseup",function(t){n=-1},!1),r.addEventListener("mousewheel",function(t){s=t.wheelDelta},!1),r.addEventListener("DOMMouseScroll",function(t){s=t.detail},!1),this.check=function(){return t.x=i,t.y=e,t.button=n,t.wheel=s,0!=n&&(n=-1),s=0,t},this.check_last=function(){return t}}function offScreen(){for(var t=0,i=[],e=0;e<1500;e++)i[e]=new y;var n=[],s=0;function r(){return++t>=1500&&(t=0),i[t]}this.spPut=function(t,i,e,s,h,o,c,u,l,f,d,m,y,p,_,v,$){var w=r();w.img=t,w.sx=i,w.sy=e,w.sw=s,w.sh=h,w.dx=o,w.dy=c,w.dw=u,w.dh=l,w.m11=f,w.m12=d,w.m21=m,w.m22=y,w.tx=p,w.ty=_,w.alpha=v,w.r=$,w.mode=a,n[n.length]=w},this.drawImgXYWHXYWH=function(t,i,e,s,a,o,c,u,l){var f=r();f.img=t,f.sx=i,f.sy=e,f.sw=s,f.sh=a,f.dx=o,f.dy=c,f.dw=u,f.dh=l,f.mode=h,n[n.length]=f},this.fillText=function(t,i,e,s){Boolean(s)||(s="limegreen");var a=r();a.text=t,a.sx=i,a.sy=e,a.color=s,a.mode=u,n[n.length]=a},this.drawImgXY=function(t,i,e){var s=r();s.img=t,s.sx=i,s.sy=e,s.mode=c,n[n.length]=s},this.drawImgXYWH=function(t,i,e,s,a){var h=r();h.img=t,h.sx=i,h.sy=e,h.sw=s,h.sh=a,h.mode=o,n[n.length]=h},this.putImageTransform=function(t,i,e,s,a,h,o){var c=r();c.img=t,c.tx=i,c.ty=e,c.m11=s,c.m12=a,c.m21=h,c.m22=o,c.mode=l,n[n.length]=c},this.transform=function(t,i,e,s){var a=r();a.m11=t,a.m12=i,a.m21=e,a.m22=s,a.mode=f,n[n.length]=a},this.putFunc=function(t){n[n.length]=t},this.allClear=function(t,i,e,s){var a=r();a.sx=t,a.sy=i,a.sw=e,a.sh=s,a.mode=d,n[n.length]=a},this.fillRect=function(t,i,e,s,a){var h=r();h.sx=t,h.sy=i,h.sw=e,h.sh=s,h.color=a,h.mode=m,n[n.length]=h},this.reset=function(){n=[],t=0},this.draw=function(t){for(var i=0,e=n.length;i<e;i++)n[i].draw(t);s<n.length&&(s=n.length)},this.count=function(){return s};var a=1,h=2,o=3,c=4,u=5,l=6,f=7,d=8,m=9;function y(){this.img,this.text,this.sx,this.sy,this.sw,this.sh,this.dx,this.dy,this.dw,this.dh,this.color,this.m11,this.m12,this.m21,this.m22,this.tx,this.ty,this.alpha,this.r,this.mode}y.prototype.func=[],y.prototype.func[0]=function(t){},y.prototype.func[a]=function(t){t.save(),t.setTransform(this.m11,this.m12,this.m21,this.m22,this.tx,this.ty),0!=this.r&&t.rotate(Math.PI/180*this.r),255==this.alpha?t.globalCompositeOperation="source-over":t.globalAlpha=this.alpha*(1/255),t.drawImage(this.img,this.sx,this.sy,this.sw,this.sh,this.dx,this.dy,this.dw,this.dh),t.restore()},y.prototype.func[h]=function(t){t.drawImage(this.img,this.sx,this.sy,this.sw,this.sh,this.dx,this.dy,this.dw,this.dh)},y.prototype.func[o]=function(t){t.drawImage(this.img,this.sx,this.sy,this.sw,this.sh)},y.prototype.func[c]=function(t){t.drawImage(this.img,this.sx,this.sy)},y.prototype.func[u]=function(t){t.fillStyle=this.color,t.fillText(this.text,this.sx,this.sy)},y.prototype.func[l]=function(t){t.save(),t.setTransform(this.m11,this.m12,this.m21,this.m22,this.tx,this.ty),t.drawImage(this.img,0,0),t.restore()},y.prototype.func[f]=function(t){},y.prototype.func[d]=function(t){t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(this.sx,this.sy,this.sw,this.sh),t.restore()},y.prototype.func[m]=function(t){Boolean(this.color)?(t.fillStyle=this.color,t.fillRect(this.sx,this.sy,this.sw,this.sh)):t.clearRect(this.sx,this.sy,this.sw,this.sh)},y.prototype.draw=function(t){this.func[this.mode].call(this,t)}}function offScreenTypeB(t,i){var e=document.createElement("canvas");e.width=t,e.height=i;var n=e.getContext("2d");this.flip=function(t){t.putImageData(n.getImageData(0,0,e.width,e.height),0,0)},this.spPut=function(t,i,e,s,r,a,h,o,c,u,l,f,d,m,y,p,_){n.save(),n.setTransform(u,l,f,d,m,y),0!=_&&n.rotate(Math.PI/180*_),255==p?n.globalCompositeOperation="source-over":n.globalAlpha=p*(1/255),n.drawImage(t,i,e,s,r,a,h,o,c),n.restore()},this.drawImgXYWHXYWH=function(t,i,e,s,r,a,h,o,c){n.drawImage(t,i,e,s,r,a,h,o,c)},this.fillText=function(t,i,e,s){Boolean(s)||(s="limegreen"),n.fillStyle=s,n.fillText(t,i,e)},this.drawImgXY=function(t,i,e){n.drawImage(t,i,e)},this.drawImgXYWH=function(t,i,e,s,r){n.drawImage(t,i,e,s,r)},this.putImageTransform=function(t,i,e,s,r,a,h){n.save(),n.setTransform(s,r,a,h,i,e),n.drawImage(t,0,0),n.restore()},this.transform=function(t,i,e,n){},this.putFunc=function(t){t.draw(n)},this.allClear=function(t,i,e,s){n.save(),n.setTransform(1,0,0,1,0,0),n.clearRect(t,i,e,s),n.restore()},this.fillRect=function(t,i,e,s,r){Boolean(r)?(n.fillStyle=r,n.fillRect(t,i,e,s)):n.clearRect(t,i,e,s)},this.reset=function(){},this.draw=function(t){this.flip(t)},this.count=function(){return 0}}function soundControl(t){var i=t.sound;this.play=function(t){var e=i[t];e.ended&&(e.currentTime=0),e.play()},this.effect=function(t){Boolean(i[t])&&(i[t].currentTime=0,i[t].play())},this.running=function(t){return!i[t].ended},this.info=function(t){var e=i[t];return e.currentTime/e.duration*100},this.restart=function(t){i[t].currentTime=0},this.volume=function(t,e){i[t].volume=e}}function GameSpriteControl(t){var i,e=[],n=[],s=!0;function r(){this.x=0,this.y=0,this.r=0,this.z=0,this.priority=0,this.collisionEnable=!0,this.collision={w:0,h:0},this.id,this.count=0,this.pcnt=0,this.visible=!1,this.hit=[],this.alive=0,this.vx=0,this.vy=0}function a(t,e,n,s,r,a,h){if(Boolean(r)||(r=e.r),Boolean(h)||(h=255),Boolean(a)||(a=1),e.fv||e.fh||0!=r||255!=h){var o=e.fv?-1:1,c=e.fh?-1:1;i.spPut(t,e.x,e.y,e.w,e.h,-e.w/2*a,-e.h/2*a,e.w*a,e.h*a,c,0,0,o,n,s,h,r)}else i.drawImgXYWHXYWH(t,e.x,e.y,e.w,e.h,n+-e.w/2*a,s+-e.h/2*a,e.w*a,e.h*a)}this.set=function(t,i,n,s,a){Boolean(e[t])||(e[t]=new r),e[t].id=i,e[t].count=0,e[t].pcnt=0,Boolean(n)?(e[t].collisionEnable=!0,e[t].collision={w:s,h:a}):e[t].collisionEnable=!1,e[t].visible=!1},this.setMove=function(t,i,n,s){var r=e[t],a=(i-90)*(Math.PI/180);r.vx=Math.cos(a)*n,r.vy=Math.sin(a)*n,r.alive=s},this.pos=function(t,i,n,s,r){var a=e[t];a.x=i,a.y=n,a.r=s,a.z=r,a.visible=!0,e[t]=a},this.reset=function(t){var i=e[t];i.visible=!1,i.collisionEnable=!1,i.alive=0,i.vx=0,i.vy=0},this.manualDraw=function(t){s=!t},this.useScreen=function(e){i=t.screen[e].buffer},this.put=function(t,s,r,h,o){var c=e[t];c.x=s,c.y=r,c.r=h,c.z=o,Boolean(n[c.id])?(a(n[c.id].image,n[c.id].pattern[c.pcnt],s,r,h,o),c.count++,c.count>n[c.id].wait&&(c.count=0,c.pcnt++),c.pcnt>n[c.id].pattern.length-1&&(c.pcnt=0)):i.fillText(t+" "+c.count,s,r)},this.get=function(t){if(Boolean(t))return Boolean(e[t])||(e[t]=new r),e[t];var i=-1;for(var n in e)e[n].visible||(i=n);return -1==i&&(i=e.length),i},this.setPattern=function(i,e){n[i]={image:t.asset.image[e.image],wait:e.wait,pattern:e.pattern}},this.check=function(t){var i=[];for(var n in e){var s=e[n];s.visible&&s.collisionEnable&&i.push(n)}for(var r=[],a={x:e[t].x,y:e[t].y,w:e[t].collision.w/2,h:e[t].collision.h/2},n=0,h=i.length;n<h;n++)if(t!=i[n]){var o={x:e[i[n]].x,y:e[i[n]].y,w:e[i[n]].collision.w/2,h:e[i[n]].collision.h/2};Math.abs(a.x-o.x)<a.w+o.w&&Math.abs(a.y-o.y)<a.h+o.h&&r.push(i[n])}return r},this.allDrawSprite=function(){if(s)for(var t in e){var r=e[t];r.alive>0&&(r.alive--,r.x+=r.vx,r.y+=r.vy,r.alive<=0&&(r.visible=!1)),r.visible&&(Boolean(n[r.id])?(a(n[r.id].image,n[r.id].pattern[r.pcnt],r.x,r.y,r.r,r.z),r.count++,r.count>n[r.id].wait&&(r.count=0,r.pcnt++),r.pcnt>n[r.id].pattern.length-1&&(r.pcnt=0)):i.fillText(t+" "+r.count,r.x,r.y))}}}function GameSpriteFontControl(t,i){var e=t.screen[0].buffer;this.useScreen=function(i){e=t.screen[i].buffer};var n=i.Image,s=i.pattern;this.putchr=function(t,i,r,a){var h=!1;Boolean(a)?1!=a&&(h=!0):a=1;for(var o=0,c=t.length;o<c;o++){var u=t.charCodeAt(o);if(u>=32&&u<128){var l=s[u-32],f=i+o*(l.w*a),d=r;h&&(f+=-l.w/2*a,d+=-l.h/2*a),e.drawImgXYWHXYWH(n,l.x,l.y,l.w,l.h,f,d,l.w*a,l.h*a)}}}}function GameStorageControl(){}